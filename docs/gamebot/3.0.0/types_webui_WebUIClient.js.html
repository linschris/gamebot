<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>types/webui/WebUIClient.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Tutorials</li><li class="nav-item"><a href="tutorial-creating_a_game.html">Creating a Game</a></li><li class="nav-item"><a href="tutorial-getting_started.html">Getting Started</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module.exports.html">exports</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module.exports_module.exports.html">exports</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="WebUIClient.html">WebUIClient</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WebUIClient.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WebUIClient.html#createWebUI">createWebUI</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="WebUIClient.html#receive">receive</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#add">add</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addPlayer">addPlayer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#buyShopItem">buyShopItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#clearCollectors">clearCollectors</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#configureOptions">configureOptions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#connect">connect</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#decrypt">decrypt</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#end">end</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#forceStop">forceStop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generateOptions">generateOptions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generateUIID">generateUIID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getPrefix">getPrefix</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hash">hash</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hasItem">hasItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#initialize">initialize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#join">join</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#leader">leader</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#mock">mock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#play">play</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#reconnect">reconnect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#refreshShopItemCache">refreshShopItemCache</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removePlayer">removePlayer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#renderOptionInfo">renderOptionInfo</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setLeader">setLeader</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#start">start</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#titleCase">titleCase</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updatePlayers">updatePlayers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateShopItem">updateShopItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validate">validate</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">types/webui/WebUIClient.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import axios from 'axios'
import WebUIManager from './WebUIManager.js'
import { Collection } from '../../discord_mod.js'

// TODO: Use Worker messages

/**
 * An API for creating WebUIs, which allow users to enter responses from a webpage
 * @class
 */
const WebUIClient = class WebUIClient {
    /**
     * Instantiates a WebUIClient.
     * @param {Discord.Client} client Constructor
     * @constructor
     */
    constructor(client) {
        this.client = client

        /**
         * A collection of the UIs, keyed by their UI IDs
         * @type {Discord.Collection&lt;WebUI>}
         */
        this.UIs = new Collection()

        // Periodically sweep UIs for expired links
        setInterval(() => {
            this.UIs.forEach(UI => {
                if(Date.now() > (UI.killAt + 5000)) {
                    this.UIs.delete(UI.id)
                }
            })
        }, 20000)
    }

    /**
     * @typedef PlayerWebResponse
     * @type {Object}
     * @property {*} result The user's result 
     */


    /**
     * The options for this WebUI.
     * @typedef WebUIOptions
     * @type {Object}
     * @property {String} type The type of WebUI to generate.
     * @property {String} message The custom message the user sees on the WebUI.
     * @property {String[][]|RegExp[][]} variables Array of [tag, replacement] pairs to customize webpage content. Accepts RegExp.
     * @property {Number} duration How long to keep the webpage alive, in seconds
     */

     /**
      * Callback to handle the data received from the Web UI
      * @callback handlePlayerWebResponse
      * @param {PlayerWebResponse} data User input received from the web UI
      * @param {Object} UI The web UI object itself
      * @param {Discord.Client} client The discord client that initiated this request
      */

    /**
     * Creates a new WebUI and returns the generated ID.
     * @param {Discord.Member|Discord.User} user The Discord user this UI is for.
     * @param {String} message The string message to display to the usser
     * @param {String[][]|RegExp[][]} variables Array of [tag, replacement] pairs to customize webpage content. Accepts RegExp.
     * @param {Number} duration How long to keep the webpage alive, in seconds
     * @param {handlePlayerWebResponse} callback The callback function that handles the data from the Web UI
     */
    create(user, message='Enter your response here', callback, variables=[['{name}', user.nickname || user.username], ['{message}', message]], type='text', duration=300) {
        return new Promise(async (resolve, reject)=> {
            const id = WebUIManager.generateUIID(user.id)

            const UI = {
                id,
                user,
                type,
                variables,
                killAt: Date.now() + (duration * 1000),
                callback
            }
            
            // Create a new UI on the manager
            axios({
                url: `${process.env.BASE_URL}/createui`,
                method: 'post',
                headers: {
                    'Connection': 'close',
                    'Web-UI-Client-Token': process.env.WEB_UI_CLIENT_TOKEN
                },
                data: {
                    id,
                    user: user.id,
                    variables,
                    type,
                    shard: this.client.shard.ids[0],
                    killAt: Date.now() + (duration * 1000)
                }
            })
            .then(() => {
                // Register UI
                this.UIs.set(id, UI)
                resolve(UI)
            })
            .catch(reject)
        })
    }

    /**
     * Receives the data and runs the callback function
     * @param {*} data The data received from the WebUI
     */
    receive(data) {
        let UI = this.UIs.get(data.id)
        if(!UI) throw new Error('UI was not found on the WebUIClient.')
        
        // Run callback
        this.UIs.get(data.id).callback(data.value, UI, this.client)
        process.nextTick(() => this.UIs.delete(data.id))
    }

    /**
     * Helper function for creating a Web UI.
     * @param {Discord.Member} member The Discord member this UI is for.
     * @param {handlePlayerWebResponse} callback The callback function that handles the data from the Web UI
     * @param {WebUIOptions} [options] The options for this WebUI.
     * @returns The UI's link
     */
    createWebUI(user, callback, options={}) {
        if(!user) throw new Error('User is a required field.')
        return new Promise((resolve, reject) => {
            // Create new UI
            this.create(user, options.message, callback, options.variables, options.type, options.duration)
            .then(UI => resolve(`${process.env.BASE_URL}/game/${UI.id}`))
            .catch(reject)
        })
    }
}

export default WebUIClient</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Mon May 17 2021 16:13:22 GMT-0700 (Pacific Daylight Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
